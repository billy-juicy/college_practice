import sys
import hashlib
from logic.db_utils import get_connection


def hash_pwd(pw: str) -> str:
    return hashlib.sha256(pw.encode()).hexdigest()


def table_empty(cur, name: str) -> bool:
    cur.execute(f"SELECT COUNT(1) FROM {name}")
    return cur.fetchone()[0] == 0


def get_map(cur, table: str, key_col: str):
    cur.execute(f"SELECT id, {key_col} FROM {table}")
    return {row[1]: row[0] for row in cur.fetchall()}


def wipe_all_tables(cur):
    """
    –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–∞–µ—Ç –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ (—Å —É—á—ë—Ç–æ–º –≤–Ω–µ—à–Ω–∏—Ö –∫–ª—é—á–µ–π)
    """
    print("‚ö†Ô∏è –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...")
    tables = [
        "order_services",
        "orders",
        "service_materials",
        "supplier_materials",
        "suppliers",
        "materials",
        "services",
        "partners",
        "employees"
    ]
    for t in tables:
        cur.execute(f"DELETE FROM {t}")
    print("‚úÖ –í—Å–µ —Ç–∞–±–ª–∏—Ü—ã —É—Å–ø–µ—à–Ω–æ –æ—á–∏—â–µ–Ω—ã.")


def main():
    wipe = "--wipe" in sys.argv
    conn = get_connection()
    cur = conn.cursor()

    try:
        if wipe:
            wipe_all_tables(cur)
            conn.commit()

        # --------------------
        # 1) employees
        # --------------------
        if table_empty(cur, "employees"):
            employees = [
                ("–ò–≤–∞–Ω–æ–≤ –°–µ—Ä–≥–µ–π –í–∏–∫—Ç–æ—Ä–æ–≤–∏—á", "1987-05-14", "4500 123456", "40817810000000000001", "–ú–µ–Ω–µ–¥–∂–µ—Ä", "–∑–¥–æ—Ä–æ–≤", "+7(900)1234567", "ivanov@cleanplanet.ru", "manager", hash_pwd("password123")),
                ("–ü–µ—Ç—Ä–æ–≤–∞ –ú–∞—Ä–∏—è –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤–Ω–∞", "1990-08-21", "4500 234567", "40817810000000000002", "–ú–µ–Ω–µ–¥–∂–µ—Ä", "–∑–¥–æ—Ä–æ–≤", "+7(900)2345678", "petrova@cleanplanet.ru", "manager", hash_pwd("password123")),
                ("–°–∏–¥–æ—Ä–æ–≤ –ê–ª–µ–∫—Å–µ–π –û–ª–µ–≥–æ–≤–∏—á", "1980-02-02", "4500 345678", "40817810000000000003", "–î–∏—Ä–µ–∫—Ç–æ—Ä", "–∑–¥–æ—Ä–æ–≤", "+7(900)3456789", "sidorov@cleanplanet.ru", "admin", hash_pwd("adminpass"))
            ]
            cur.executemany("""
                INSERT INTO employees (full_name, birth_date, passport, bank_account, position, health_status, phone, email, role, password)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            """, employees)
            print("‚úÖ –í—Å—Ç–∞–≤–ª–µ–Ω—ã —Ç–µ—Å—Ç–æ–≤—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏.")
        else:
            print("‚ÑπÔ∏è –¢–∞–±–ª–∏—Ü–∞ employees –Ω–µ –ø—É—Å—Ç–∞ ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –≤—Å—Ç–∞–≤–∫—É.")

        # --------------------
        # 2) partners
        # --------------------
        if table_empty(cur, "partners"):
            partners = [
                ("–ü—É–Ω–∫—Ç –ø—Ä–∏—ë–º–∞-–≤—ã–¥–∞—á–∏", '–û–û–û "–ß–∏—Å—Ç—ã–π –î–æ–º"', "–≥. –ú–æ—Å–∫–≤–∞, —É–ª. –õ–µ–Ω–∏–Ω–∞, 10", "7701234567", "–ò–≤–∞–Ω–æ–≤ –ò.–ò.", "+7(999)1234567", "info@cleanhome.ru", "", 5.0),
                ("–ü—É–Ω–∫—Ç –ø—Ä–∏—ë–º–∞-–≤—ã–¥–∞—á–∏", '–û–û–û "–ó–µ–ª–µ–Ω—ã–π –°–∞–¥"', "–≥. –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥, –ù–µ–≤—Å–∫–∏–π –ø—Ä., 25", "7801234568", "–ü–µ—Ç—Ä–æ–≤ –ü.–ü.", "+7(911)2223344", "garden@mail.ru", "", 4.0),
                ("–ü–∞—Ä—Ç–Ω—ë—Ä", "–ò–ü –°–∏–Ω–∏—Ü—ã–Ω", "–≥. –ö–∞–∑–∞–Ω—å, —É–ª. –ë–∞—É–º–∞–Ω–∞, 12", "165001234567", "–°–∏–Ω–∏—Ü—ã–Ω –°.–°.", "+7(987)6543210", "sinitsyn@bk.ru", "", 3.0)
            ]
            cur.executemany("""
                INSERT INTO partners (type, name, legal_address, inn, director_name, phone, email, logo_url, rating)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
            """, partners)
            print("‚úÖ –í—Å—Ç–∞–≤–ª–µ–Ω—ã —Ç–µ—Å—Ç–æ–≤—ã–µ –ø–∞—Ä—Ç–Ω—ë—Ä—ã.")
        else:
            print("‚ÑπÔ∏è –¢–∞–±–ª–∏—Ü–∞ partners –Ω–µ –ø—É—Å—Ç–∞ ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –≤—Å—Ç–∞–≤–∫—É.")

        # --------------------
        # 3) services
        # --------------------
        if table_empty(cur, "services"):
            services = [
                ("SVC001", "–õ–æ–≥–∏—Å—Ç–∏–∫–∞", "–í—ã–≤–æ–∑ –º—É—Å–æ—Ä–∞", "–°–±–æ—Ä –∏ –≤—ã–≤–æ–∑ –±—ã—Ç–æ–≤—ã—Ö –æ—Ç—Ö–æ–¥–æ–≤", "", 500.0, 1, 800.0, 1, 1),
                ("SVC002", "–•–∏–º—á–∏—Å—Ç–∫–∞", "–•–∏–º—á–∏—Å—Ç–∫–∞ –∫–æ–≤—Ä–æ–≤", "–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è —á–∏—Å—Ç–∫–∞ –∫–æ–≤—Ä–æ–≤", "", 1000.0, 2, 1500.0, 1, 2),
                ("SVC003", "–£–±–æ—Ä–∫–∞", "–£–±–æ—Ä–∫–∞ –ø–æ–º–µ—â–µ–Ω–∏–π", "–ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è —É–±–æ—Ä–∫–∞ –æ—Ñ–∏—Å–æ–≤ –∏ –∫–≤–∞—Ä—Ç–∏—Ä", "", 1500.0, 3, 2000.0, 1, 3),
                ("SVC004", "–ú–æ–π–∫–∞", "–ú—ã—Ç—å—ë –æ–∫–æ–Ω", "–ú–æ–π–∫–∞ –æ–∫–æ–Ω –Ω–∞ –≤—ã—Å–æ—Ç–µ –¥–æ 3 –º", "", 700.0, 1, 1200.0, 1, 1),
                ("SVC005", "–î–µ–∑–∏–Ω—Ñ–µ–∫—Ü–∏—è", "–î–µ–∑–∏–Ω—Ñ–µ–∫—Ü–∏—è", "–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–º–µ—â–µ–Ω–∏–π –∞–Ω—Ç–∏—Å–µ–ø—Ç–∏–∫–∞–º–∏", "", 2000.0, 2, 2500.0, 1, 2)
            ]
            cur.executemany("""
                INSERT INTO services (code, type, name, description, image_url, min_cost, time_norm, estimated_cost, workshop_number, staff_count)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            """, services)
            print("‚úÖ –í—Å—Ç–∞–≤–ª–µ–Ω—ã —Ç–µ—Å—Ç–æ–≤—ã–µ —É—Å–ª—É–≥–∏.")
        else:
            print("‚ÑπÔ∏è –¢–∞–±–ª–∏—Ü–∞ services –Ω–µ –ø—É—Å—Ç–∞ ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –≤—Å—Ç–∞–≤–∫—É.")

        # --------------------
        # 4) materials
        # --------------------
        if table_empty(cur, "materials"):
            materials = [
                ("–†–∞—Å—Ö–æ–¥–Ω—ã–π", "–ú–µ—à–∫–∏ –¥–ª—è –º—É—Å–æ—Ä–∞", 10, "—à—Ç.", "–ü–∞–∫–µ—Ç—ã –¥–ª—è —Å–±–æ—Ä–∞ –º—É—Å–æ—Ä–∞", "", 5.0, 500, 50),
                ("–•–∏–º–∏—è", "–ú–æ—é—â–∏–µ —Å—Ä–µ–¥—Å—Ç–≤–∞", 1, "–ª", "–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ –º–æ—é—â–∏–µ —Å—Ä–µ–¥—Å—Ç–≤–∞", "", 150.0, 200, 10),
                ("–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å", "–¢—Ä—è–ø–∫–∏ –¥–ª—è —É–±–æ—Ä–∫–∏", 10, "—à—Ç.", "–¢—Ä—è–ø–∫–∏ –º–∏–∫—Ä–æ—Ñ–∏–±—Ä–∞", "", 20.0, 300, 30),
                ("–•–∏–º–∏—è", "–î–µ–∑–∏–Ω—Ñ–∏—Ü–∏—Ä—É—é—â–∏–π —Ä–∞—Å—Ç–≤–æ—Ä", 5, "–ª", "–°—Ä–µ–¥—Å—Ç–≤–æ –¥–ª—è –¥–µ–∑–∏–Ω—Ñ–µ–∫—Ü–∏–∏", "", 300.0, 100, 10),
                ("–†–∞—Å—Ö–æ–¥–Ω—ã–π", "–ü–µ—Ä—á–∞—Ç–∫–∏ —Ä–µ–∑–∏–Ω–æ–≤—ã–µ", 20, "–ø–∞—Ä", "–û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ –ø–µ—Ä—á–∞—Ç–∫–∏", "", 50.0, 400, 20)
            ]
            cur.executemany("""
                INSERT INTO materials (type, name, quantity_per_package, unit, description, image_url, cost, stock_quantity, min_stock)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
            """, materials)
            print("‚úÖ –í—Å—Ç–∞–≤–ª–µ–Ω—ã —Ç–µ—Å—Ç–æ–≤—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã.")
        else:
            print("‚ÑπÔ∏è –¢–∞–±–ª–∏—Ü–∞ materials –Ω–µ –ø—É—Å—Ç–∞ ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –≤—Å—Ç–∞–≤–∫—É.")

        # --------------------
        # 5) suppliers
        # --------------------
        if table_empty(cur, "suppliers"):
            suppliers = [
                ("–û–û–û –ü–æ—Å—Ç–∞–≤—â–∏–∫1", "7701112223"),
                ("–û–û–û –ü–æ—Å—Ç–∞–≤—â–∏–∫2", "7701113334")
            ]
            cur.executemany("INSERT INTO suppliers (name, inn) VALUES (?, ?)", suppliers)
            print("‚úÖ –í—Å—Ç–∞–≤–ª–µ–Ω—ã –ø–æ—Å—Ç–∞–≤—â–∏–∫–∏.")
        else:
            print("‚ÑπÔ∏è –¢–∞–±–ª–∏—Ü–∞ suppliers –Ω–µ –ø—É—Å—Ç–∞ ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –≤—Å—Ç–∞–≤–∫—É.")

        conn.commit()

        # –î–∞–ª–µ–µ –±–ª–æ–∫–∏ —Å –ø–æ—Å—Ç–∞–≤–∫–∞–º–∏, —Å–≤—è–∑—è–º–∏ –∏ –∑–∞–∫–∞–∑–∞–º–∏ –∏–¥–µ–Ω—Ç–∏—á–Ω—ã –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏
        # (–æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å, —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Å—å –∫–æ–¥ ‚Äî –æ–Ω —Ç–æ—Ç –∂–µ)

        print("\nüü¢ –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.")
        if wipe:
            print("‚ÄºÔ∏è –í—Å–µ —Ç–∞–±–ª–∏—Ü—ã –±—ã–ª–∏ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –æ—á–∏—â–µ–Ω—ã (--wipe).")

    except Exception as e:
        print("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö:", e)
        conn.rollback()
    finally:
        conn.close()


if __name__ == "__main__":
    main()
